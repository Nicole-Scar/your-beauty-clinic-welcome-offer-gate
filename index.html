// Redirect handler with dynamic spinner
export default async function handler(req, res) {
  const { contactId, sessionId, trigger_link, ...rest } = req.query;

  // Step 1 — Always force a clean reload once using cache-buster
  if (!req.query.cb) {
    const cb = Date.now();
    const newUrl = new URL(req.url, `https://${req.headers.host}`);
    newUrl.searchParams.set("cb", cb);
    return res.redirect(302, newUrl.toString());
  }

  // Step 2 — Clean UTM collection after reload
  const utmParams = {};
  Object.keys(rest).forEach((key) => {
    if (key.startsWith("utm_")) utmParams[key] = rest[key];
  });

  // Step 3 — Build final target URL
  const final = new URL(
    "https://yourbeautyclinic.bookedbeauty.co/your-beauty-clinic-welcome-offer-161477"
  );

  if (contactId) final.searchParams.set("contactId", contactId);
  if (sessionId) final.searchParams.set("sessionId", sessionId);
  if (trigger_link) final.searchParams.set("trigger_link", trigger_link);
  Object.keys(utmParams).forEach((key) => {
    final.searchParams.set(key, utmParams[key]);
  });

  const finalUrl = final.toString();

  // Step 4 — Return a dynamic spinner page (never cached)
  res.setHeader("Cache-Control", "no-store, no-cache, must-revalidate");
  res.setHeader("Content-Type", "text/html");

  return res.send(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <title>Validating your offer...</title>
      <style>
        body {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          height: 100vh;
          background: #faf7f5;
          font-family: system-ui, sans-serif;
          color: #333;
          margin: 0;
        }
        .spinner {
          width: 40px;
          height: 40px;
          border: 4px solid #ddd;
          border-top: 4px solid #c49a6c;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
      </style>
    </head>
    <body>
      <div class="spinner"></div>
      <p>Verifying your offer...</p>

      <script>
        setTimeout(() => {
          window.location.replace(${JSON.stringify(finalUrl)});
        }, 2000);
      </script>
    </body>
    </html>
  `);
}
